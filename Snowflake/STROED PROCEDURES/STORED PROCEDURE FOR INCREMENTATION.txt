CREATE OR REPLACE PROCEDURE uk_accident_incremental_proc()
RETURNS STRING
LANGUAGE SQL   
EXECUTE AS CALLER
AS
$$
BEGIN
MERGE into DB_UK_ROADSAFETY.MAIN.UK_ACCIDENT AS t
USING (SELECT * FROM DB_UK_ROADSAFETY.RAW.UK_ACCIDENT) AS s ON t.ACCIDENT_INDEX = s.ACCIDENT_INDEX
WHEN MATCHED AND (t.ACCIDENT_INDEX != s.ACCIDENT_INDEX or t.LOCATION_EASTING_OSGR != s.LOCATION_EASTING_OSGR OR t.LOCATION_NORTHING_OSGR != s.LOCATION_NORTHING_OSGR OR t.LONGITUDE != s.LONGITUDE OR t.LATITUDE != s.LATITUDE OR t.POLICE_FORCE != s.POLICE_FORCE OR t.ACCIDENT_SEVERITY != s.ACCIDENT_SEVERITY OR t.NUMBER_OF_VEHICLES != s.NUMBER_OF_VEHICLES OR t.NUMBER_OF_CASUALTIES != s.NUMBER_OF_CASUALTIES OR t.DATE != s.DATE OR t.DAY_OF_WEEK != s.DAY_OF_WEEK OR t.TIME != s.TIME OR t.LOCAL_AUTHORITY_DISTRICT != s.LOCAL_AUTHORITY_DISTRICT OR t.LOCAL_AUTHORITY_HIGHWAY != s.LOCAL_AUTHORITY_HIGHWAY OR t."1ST_ROAD_CLASS" != s."1ST_ROAD_CLASS" OR t."1ST_ROAD_NUMBER" != s."1ST_ROAD_NUMBER" OR t.ROAD_TYPE != s.ROAD_TYPE OR t.SPEED_LIMIT != s.SPEED_LIMIT OR t.JUNCTION_CONTROL != s.JUNCTION_CONTROL OR t."2ND_ROAD_CLASS" != s."2ND_ROAD_CLASS" OR t."2ND_ROAD_NUMBER" != s."2ND_ROAD_NUMBER" OR t.PEDESTRIAN_CROSSING_HUMAN_CONTROL != s.PEDESTRIAN_CROSSING_HUMAN_CONTROL OR t.PEDESTRIAN_CROSSING_PHYSICAL_FACILITIES != s.PEDESTRIAN_CROSSING_PHYSICAL_FACILITIES OR t.LIGHT_CONDITIONS != s.LIGHT_CONDITIONS OR t.WEATHER_CONDITIONS != s.WEATHER_CONDITIONS OR t.ROAD_SURFACE_CONDITIONS != s.ROAD_SURFACE_CONDITIONS OR t.SPECIAL_CONDITIONS_AT_SITE != s.SPECIAL_CONDITIONS_AT_SITE OR t.CARRIAGEWAY_HAZARDS != s.CARRIAGEWAY_HAZARDS OR t.URBAN_OR_RURAL_AREA != s.URBAN_OR_RURAL_AREA OR t.DID_POLICE_OFFICER_ATTEND_SCENE_OF_ACCIDENT != s.DID_POLICE_OFFICER_ATTEND_SCENE_OF_ACCIDENT OR t.LSOA_OF_ACCIDENT_LOCATION != s.LSOA_OF_ACCIDENT_LOCATION OR t.YEAR != s.YEAR)
THEN UPDATE SET
t.ACCIDENT_INDEX = s.ACCIDENT_INDEX,
t.LOCATION_EASTING_OSGR = s.LOCATION_EASTING_OSGR,
t.LOCATION_NORTHING_OSGR = s.LOCATION_NORTHING_OSGR,
t.LONGITUDE = s.LONGITUDE,
t.LATITUDE = s.LATITUDE,
t.POLICE_FORCE = s.POLICE_FORCE,
t.ACCIDENT_SEVERITY = s.ACCIDENT_SEVERITY,
t.NUMBER_OF_VEHICLES = s.NUMBER_OF_VEHICLES,
t.NUMBER_OF_CASUALTIES = s.NUMBER_OF_CASUALTIES,
t.DATE = s.DATE,
t.DAY_OF_WEEK = s.DAY_OF_WEEK,
t.TIME = s.TIME,
t.LOCAL_AUTHORITY_DISTRICT = s.LOCAL_AUTHORITY_DISTRICT,
t.LOCAL_AUTHORITY_HIGHWAY = s.LOCAL_AUTHORITY_HIGHWAY,
t."1ST_ROAD_CLASS" = s."1ST_ROAD_CLASS",
t."1ST_ROAD_NUMBER" = s."1ST_ROAD_NUMBER",
t.ROAD_TYPE = s.ROAD_TYPE,
t.SPEED_LIMIT = s.SPEED_LIMIT,
t.JUNCTION_CONTROL = s.JUNCTION_CONTROL,
t."2ND_ROAD_CLASS" = s."2ND_ROAD_CLASS",
t."2ND_ROAD_NUMBER" = s."2ND_ROAD_NUMBER",
t.PEDESTRIAN_CROSSING_HUMAN_CONTROL = s.PEDESTRIAN_CROSSING_HUMAN_CONTROL,
t.PEDESTRIAN_CROSSING_PHYSICAL_FACILITIES = s.PEDESTRIAN_CROSSING_PHYSICAL_FACILITIES,
t.LIGHT_CONDITIONS = s.LIGHT_CONDITIONS,
t.WEATHER_CONDITIONS = s.WEATHER_CONDITIONS,
t.ROAD_SURFACE_CONDITIONS = s.ROAD_SURFACE_CONDITIONS,
t.SPECIAL_CONDITIONS_AT_SITE = s.SPECIAL_CONDITIONS_AT_SITE,
t.CARRIAGEWAY_HAZARDS = s.CARRIAGEWAY_HAZARDS, 
t.URBAN_OR_RURAL_AREA = s.URBAN_OR_RURAL_AREA,
t.DID_POLICE_OFFICER_ATTEND_SCENE_OF_ACCIDENT = s.DID_POLICE_OFFICER_ATTEND_SCENE_OF_ACCIDENT,       			 
t.LSOA_OF_ACCIDENT_LOCATION = s.LSOA_OF_ACCIDENT_LOCATION,
t.YEAR = s.YEAR,
UPDATE_DATE=CURRENT_TIMESTAMP
WHEN NOT MATCHED THEN INSERT
(
ACCIDENT_INDEX,
LOCATION_EASTING_OSGR,
LOCATION_NORTHING_OSGR,
LONGITUDE,
LATITUDE,
POLICE_FORCE,
ACCIDENT_SEVERITY,
NUMBER_OF_VEHICLES,
NUMBER_OF_CASUALTIES,
DATE,
DAY_OF_WEEK,
TIME,
LOCAL_AUTHORITY_DISTRICT,
LOCAL_AUTHORITY_HIGHWAY,
"1ST_ROAD_CLASS",
"1ST_ROAD_NUMBER",
ROAD_TYPE,
SPEED_LIMIT,
JUNCTION_CONTROL,
"2ND_ROAD_CLASS",
"2ND_ROAD_NUMBER",
PEDESTRIAN_CROSSING_HUMAN_CONTROL,
PEDESTRIAN_CROSSING_PHYSICAL_FACILITIES,
LIGHT_CONDITIONS,
WEATHER_CONDITIONS,
ROAD_SURFACE_CONDITIONS,
SPECIAL_CONDITIONS_AT_SITE,
CARRIAGEWAY_HAZARDS,
URBAN_OR_RURAL_AREA,
DID_POLICE_OFFICER_ATTEND_SCENE_OF_ACCIDENT,
LSOA_OF_ACCIDENT_LOCATION,
YEAR,
INSERT_DATE,
UPDATE_DATE)
VALUES(
s.ACCIDENT_INDEX,
s.LOCATION_EASTING_OSGR,
s.LOCATION_NORTHING_OSGR,
s.LONGITUDE,
s.LATITUDE,
s.POLICE_FORCE,
s.ACCIDENT_SEVERITY,
s.NUMBER_OF_VEHICLES,
s.NUMBER_OF_CASUALTIES,
s.DATE,
s.DAY_OF_WEEK,
s.TIME,
s.LOCAL_AUTHORITY_DISTRICT,
s.LOCAL_AUTHORITY_HIGHWAY,
s."1ST_ROAD_CLASS",
s."1ST_ROAD_NUMBER",
s.ROAD_TYPE,
s.SPEED_LIMIT,
s.JUNCTION_CONTROL,
s."2ND_ROAD_CLASS",
s."2ND_ROAD_NUMBER",
s.PEDESTRIAN_CROSSING_HUMAN_CONTROL,
s.PEDESTRIAN_CROSSING_PHYSICAL_FACILITIES,
s.LIGHT_CONDITIONS,
s.WEATHER_CONDITIONS,
s.ROAD_SURFACE_CONDITIONS,
s.SPECIAL_CONDITIONS_AT_SITE,
s.CARRIAGEWAY_HAZARDS,
s.URBAN_OR_RURAL_AREA,
s.DID_POLICE_OFFICER_ATTEND_SCENE_OF_ACCIDENT,
s.LSOA_OF_ACCIDENT_LOCATION,
s.YEAR,
CURRENT_TIMESTAMP(),
CURRENT_TIMESTAMP()
);
RETURN 'SUCCESS';
END;
$$;